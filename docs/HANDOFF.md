# Monorail: Handoff Context

> **TL;DR:** v0 is complete. WebSocket bridge works. Full round-trip loop (Claude ↔ Figma) is functional.

## What Is This?

**Monorail** is a system for making presentation decks that have narrative coherence—not just pretty slides. It's an MCP tool that gives Claude the ability to read and write Figma Slides, enabling a collaborative loop where Claude proposes, human spikes directly in Figma, and Claude sees the changes and adapts.

Named after The Simpsons' "Marge vs. the Monorail" episode—Lyle Lanley's pitch is a masterclass in narrative structure. The argument lands so hard it sells Springfield a monorail (which turns out to be a disaster, but the pitch was flawless).

### The Names

| Name | Reference | Meaning |
|------|-----------|---------|
| **Monorail** | The episode/pitch | The product — decks with arguments that land |
| **Ralph Wiggum** | The development methodology | How we build — iterative loops until done |

We use the **Ralph Wiggum approach** (persistent plan, clean sessions, findings log) to develop the product. See `PLAN.md` at project root.

---

## Files in This Project

### Core Specs
- **ARCHITECTURE.md** — System vision and component overview
- **SKILL.md** — Narrative toolkit for Claude (spine, beats, hallway test, constraints)
- **PLUGIN-SPEC.md** — IR format spec for the Figma plugin

### Implementation
- **src/index.ts** — MCP server (WebSocket server + tools)
- **figma-plugin/code.ts** — Figma plugin (Apply + Export)
- **figma-plugin/ui.html** — Plugin UI (activity feed + WebSocket client)

### Decision Records
- **decisions/websocket-bridge.md** — WebSocket protocol design (IMPLEMENTED ✅)
- **decisions/freeform-handling.md** — Update-in-place + extras capture (IMPLEMENTED ✅)
- **decisions/local-mcp.md** — Why local, not remote

### Reference Material
- **references/archetypes.md** — The 10 constrained slide templates with word limits
- **references/narrative.md** — Theory: spines, turns, stakes, argument structure
- **references/critics.md** — QA heuristics for checking deck quality at each level

### Outputs
- **examples/index.html** — Landing page for Monorail
- **examples/monorail-deck-v0.html** — Demo deck built using the system

### Meta
- **failures.md** — Learnings log (actively updated — check here for gotchas!)

---

## Current State (v0 Complete ✅)

**What's built and working:**

| Component | Status | Location |
|-----------|--------|----------|
| MCP server | ✅ Working | `src/index.ts` |
| WebSocket bridge | ✅ Working | Port 9876, auto-connects |
| Figma plugin | ✅ Working | `figma-plugin/` |
| Export IR | ✅ Working | Analyzes slides, detects archetypes |
| Apply to Deck | ✅ Working | Creates/updates slides, respects locks |
| HTML preview | ✅ Working | Generated by MCP tools |
| Freeform handling | ✅ Working | Update-in-place, captures extras |

**MCP Tools available:**
- `monorail_connection_status` — Check if plugin is connected
- `monorail_push_ir` — Send IR directly to plugin (auto-apply)
- `monorail_pull_ir` — Request export, returns IR
- `monorail_create_deck` — Create deck from IR
- `monorail_preview` — Generate HTML preview

**What's next (v1):**
- Delete slide capability
- IR validation (prevent malformed IR crashes)
- `preserveLayout` mode (update text only, preserve human formatting)
- Figma Slides best practices (Auto Layout, Components)
- Design co-creation investigation

---

## The Core Loop (Working! ✅)

```
Claude                              Figma Plugin
   │                                      │
   ├──── monorail_push_ir ───────────────►│ (auto-applies)
   │                                      │
   │◄──── monorail_pull_ir ───────────────┤ (exports & returns IR)
   │                                      │
   │                                Human edits in Figma
   │                                (move, restyle, add content)
   │                                      │
   └──────────── repeat ──────────────────┘
```

**No copy/paste required.** Claude pushes IR directly to the plugin, pulls exports back. Human edits survive (in-place updates preserve formatting).

The insight: Figma isn't just an output target—it's a shared canvas. Both Claude and human work in the same space. Claude sees human edits and adapts.

---

## The Narrative Model

Every deck needs a **spine**:
- **Setup** — The world as it is. The problem. The stakes.
- **Turn** — The shift. Why now. What changes.
- **Landing** — The ask. The takeaway.

**Hallway test**: If someone walks out and a colleague asks "what was that about?"—what's the one sentence they say? That sentence should be concrete and should appear on a slide.

**Deletion test**: For every slide, ask "if I cut this, does the argument break?" If no, it's filler.

---

## Key Design Decisions Made

1. **MCP + WebSocket, not REST API** — Figma MCP doesn't support Slides, REST API is read-only. Solution: custom MCP server + WebSocket bridge to plugin.
2. **IR as bridge** — Structured JSON that Claude writes, plugin renders to Figma
3. **Partial locking** — Slides have status: locked | draft | stub. Claude respects what's settled.
4. **Constraints force clarity** — Headlines ≤8 words, 3 bullets max, etc. If content overflows, edit the content, not the constraint.
5. **Update in place** — Apply modifies existing text nodes instead of re-rendering (preserves human formatting)
6. **Extras capture** — Export captures text that doesn't fit archetypes (Claude sees everything)
7. **Local MCP** — Everything runs on user's machine (privacy, latency, simplicity)

---

## Answered Questions (from exploration)

| Question | Answer |
|----------|--------|
| Can Figma MCP read Slides? | ❌ No — only supports Design/FigJam/Make |
| Can REST API write to Figma? | ❌ No — read-only for design content |
| Can plugin connect to localhost WebSocket? | ✅ Yes — works perfectly |
| How to transfer IR without copy/paste? | ✅ WebSocket bridge (push/pull tools) |

---

## Open Questions (for v1+)

1. **Visual feedback** — Claude can't see rendered output (text overflow, layout issues)
2. **Delete capability** — Plugin can only create/update, not delete orphan slides
3. **Template integration** — Our archetypes bypass Figma's native template system
4. **Design co-creation** — HTML output is beautiful, Figma output is functional text dumps

---

## Vibe Check

The project has a specific tone: playful but substantive. The Simpsons references aren't decoration—they capture something real about the problem space.

- "What about us brain-dead slobs?" / "You'll be given cushy jobs!" — That's objection handling
- "I've sold monorails to Brockway, Ogdenville, and North Haverbrook" — That's credibility
- "Monorail!" (the crowd chanting) — That's the moment the argument clicks

Lean into it. The name is good. The energy is good. **v0 is built. Now we polish.**

---

## Quick Start

1. **Install:** Add monorail to `~/.cursor/mcp.json`
2. **Open:** Figma Slides → Plugins → Monorail
3. **Connect:** Plugin auto-connects to WebSocket (green indicator)
4. **Use:**
   - `monorail_pull_ir` — get current deck from Figma
   - `monorail_push_ir` — send updated IR to Figma (auto-applies)
   - Iterate until the deck lands

**If connection issues:** Check for multiple MCP processes (`ps aux | grep monorail`). Only one can bind port 9876.
